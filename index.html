<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Cairo & Tajawal -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Cairo', 'Tajawal', sans-serif;
            background-color: #0f172a; /* slate-900 */
            color: #f8fafc;
            overflow-x: hidden;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .view-section {
            display: none;
            width: 100%;
            justify-content: center;
        }
        .view-section.active {
            display: flex;
        }
        /* Custom Scrollbar for Admin Table */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative selection:bg-amber-500/30">

    <!-- Background Ornaments -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-amber-600/10 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-900/20 rounded-full blur-[100px]"></div>
        <div class="absolute top-10 right-10 text-amber-500/20 text-4xl animate-pulse">âœ¨</div>
        <div class="absolute top-40 left-20 text-amber-500/10 text-6xl animate-pulse" style="animation-delay: 1s;">âœ¨</div>
        <div class="absolute bottom-20 right-1/4 text-amber-500/20 text-3xl animate-pulse" style="animation-delay: 2s;">âœ¨</div>
    </div>

    <!-- Main Container -->
    <div class="z-10 w-full flex justify-center">

        <!-- ================= HOME VIEW ================= -->
        <div id="view-home" class="view-section active animate-fade-in">
            <div class="flex flex-col items-center justify-center space-y-6 text-center">
                <img src="https://storage.googleapis.com/akm1983/%D8%B4%D8%B9%D8%A7%D8%B1-02.png" alt="Ø´Ø¹Ø§Ø± ÙØ±ÙŠÙ‚ Ø§Ù„Ø¸Ø§Ù‡Ø± Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ" class="w-32 md:w-48 h-auto object-contain drop-shadow-[0_0_20px_rgba(255,255,255,0.1)] z-10" />
                <div class="relative">
                    <i class="fas fa-moon text-amber-400 text-7xl md:text-8xl drop-shadow-[0_0_15px_rgba(251,191,36,0.5)]"></i>
                    <i class="fas fa-star text-amber-200 text-2xl absolute -top-2 -right-2 animate-pulse"></i>
                </div>
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold text-white mb-4 drop-shadow-lg">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ù€Ø§Ù† Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙ€Ø©</h1>
                    <p class="text-xl text-amber-100/80 max-w-md mx-auto">Ø§Ø®ØªØ¨Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© ÙˆØ§Ø±Ø¨Ø­ Ø¬ÙˆØ§Ø¦Ø² Ù‚ÙŠÙ…Ø© ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹</p>
                    <div class="mt-6 bg-slate-800/80 border border-slate-700 rounded-full px-6 py-3 inline-block shadow-lg">
                        <p class="text-sm md:text-base text-amber-400 font-bold">
                            ØªÙ†Ø¸ÙŠÙ…: Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„Ø«Ù‚Ø§ÙÙŠØ© ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ø¨ÙØ±ÙŠÙ‚ Ø§Ù„Ø¸Ø§Ù‡Ø± Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ
                        </p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 w-full max-w-md mt-8">
                    <button onclick="switchView('register')" class="flex-1 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-400 hover:to-amber-500 text-slate-900 font-bold py-4 px-6 rounded-2xl shadow-xl transform transition hover:scale-105 flex items-center justify-center gap-2">
                        <i class="fas fa-users text-lg"></i>
                        <span>Ø´Ø§Ø±Ùƒ Ø§Ù„Ø¢Ù†</span>
                    </button>
                    <button onclick="switchView('admin-login')" class="flex-1 bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white font-bold py-4 px-6 rounded-2xl shadow-xl transform transition hover:scale-105 flex items-center justify-center gap-2">
                        <i class="fas fa-shield-halved text-amber-400 text-lg"></i>
                        <span>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= REGISTER VIEW ================= -->
        <div id="view-register" class="view-section animate-fade-in">
            <div class="w-full max-w-md bg-slate-800/80 backdrop-blur-md p-8 rounded-3xl shadow-2xl border border-slate-700">
                <h2 class="text-2xl font-bold text-white mb-6 text-center border-b border-slate-700 pb-4">ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</h2>
                <form id="form-register" class="space-y-6">
                    <div>
                        <label class="block text-amber-300 mb-2 text-sm font-semibold">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
                        <input type="text" id="input-name" required class="w-full bg-slate-900 border border-slate-700 text-white rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
                    </div>
                    <div>
                        <label class="block text-amber-300 mb-2 text-sm font-semibold">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø¹ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„ÙŠ)</label>
                        <input type="tel" id="input-phone" required class="w-full bg-slate-900 border border-slate-700 text-white rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-amber-500 text-left" placeholder="Ù…Ø«Ø§Ù„: 96899999999+" dir="ltr">
                        <p class="text-xs text-slate-400 mt-2">Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„Ø¥Ø¨Ù„Ø§ØºÙƒ Ø¨Ø§Ù„ÙÙˆØ² Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</p>
                    </div>
                    <button type="submit" class="w-full bg-amber-500 hover:bg-amber-400 text-slate-900 font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition">
                        <span>Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø£Ø³Ø¦Ù„Ø©</span>
                        <i class="fas fa-chevron-left text-sm"></i>
                    </button>
                    <button type="button" onclick="switchView('home')" class="w-full text-slate-400 hover:text-white text-sm mt-4 transition">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                </form>
            </div>
        </div>

        <!-- ================= WEEK SELECTION VIEW ================= -->
        <div id="view-week-selection" class="view-section animate-fade-in">
            <div class="w-full max-w-lg bg-slate-800/80 backdrop-blur-md p-8 rounded-3xl shadow-2xl border border-slate-700">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-white mb-2">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ <span id="display-name"></span> ğŸ‘‹</h2>
                    <p class="text-amber-200/80">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="weeks-container">
                    <!-- Weeks will be injected here via JS -->
                </div>
            </div>
        </div>

        <!-- ================= QUIZ VIEW ================= -->
        <div id="view-quiz" class="view-section animate-fade-in">
            <div class="w-full max-w-2xl bg-slate-800/90 backdrop-blur-md p-6 md:p-10 rounded-3xl shadow-2xl border border-slate-700 overflow-y-auto max-h-[85vh]">
                <div class="flex justify-between items-center border-b border-slate-700 pb-4 mb-6">
                    <h2 class="text-2xl font-bold text-white" id="quiz-title">Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h2>
                    <span class="bg-amber-500/20 text-amber-400 px-4 py-1 rounded-full text-sm font-semibold" id="quiz-count"></span>
                </div>
                
                <div id="questions-container" class="space-y-8">
                    <!-- Questions will be injected here via JS -->
                </div>

                <div class="mt-8 flex gap-4">
                    <button onclick="switchView('week-selection')" class="px-6 py-3 rounded-xl font-bold text-slate-300 bg-slate-700 hover:bg-slate-600 transition">Ø±Ø¬ÙˆØ¹</button>
                    <button id="btn-submit-quiz" onclick="submitQuiz()" disabled class="flex-1 py-3 rounded-xl font-bold text-slate-900 flex items-center justify-center gap-2 transition bg-slate-600 cursor-not-allowed opacity-50">
                        <span id="submit-text">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</span>
                        <i class="fas fa-circle-check text-lg hidden" id="submit-icon"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= SUCCESS VIEW ================= -->
        <div id="view-success" class="view-section animate-fade-in">
            <div class="w-full max-w-md bg-slate-800/90 backdrop-blur-md p-10 rounded-3xl shadow-2xl border border-slate-700 text-center">
                <div class="w-24 h-24 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-circle-check text-5xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-white mb-4">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!</h2>
                <p class="text-slate-300 mb-8 leading-relaxed">
                    Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø´Ø§Ø±ÙƒØªÙƒ. ØªÙ… Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­.
                    <br/><br/>
                    Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨. Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø§Ù„ØªÙˆÙÙŠÙ‚! ğŸŒ™
                </p>
                <button onclick="resetAndGoHome()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl transition">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            </div>
        </div>

        <!-- ================= ADMIN LOGIN VIEW ================= -->
        <div id="view-admin-login" class="view-section animate-fade-in">
            <div class="w-full max-w-sm bg-slate-800/90 backdrop-blur-md p-8 rounded-3xl shadow-2xl border border-slate-700 text-center">
                <i class="fas fa-shield-halved text-5xl text-amber-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-white mb-6">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
                <form id="form-admin-login">
                    <input type="password" id="input-admin-pin" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full bg-slate-900 border border-slate-700 text-white rounded-xl px-4 py-3 text-center text-xl tracking-widest mb-4 focus:outline-none focus:border-amber-500" dir="ltr">
                    <p id="admin-error" class="text-red-400 text-sm mb-4 hidden">Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­</p>
                    <button type="submit" class="w-full bg-amber-500 hover:bg-amber-400 text-slate-900 font-bold py-3 rounded-xl transition">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                </form>
                <p class="text-xs text-slate-500 mt-6">Ù„Ù„ØªØ¬Ø±Ø¨Ø©ØŒ Ø§Ù„Ø±Ù…Ø² Ù‡Ùˆ: 2026</p>
                <button onclick="switchView('home')" class="mt-4 text-slate-400 text-sm hover:text-white">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>

        <!-- ================= ADMIN DASHBOARD VIEW ================= -->
        <div id="view-admin-dashboard" class="view-section animate-fade-in">
            <div class="w-full max-w-6xl bg-slate-800/95 backdrop-blur-md rounded-3xl shadow-2xl border border-slate-700 flex flex-col h-[90vh]">
                <!-- Header -->
                <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-900/50 rounded-t-3xl">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-award text-3xl text-amber-400"></i>
                        <h2 class="text-2xl font-bold text-white">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h2>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="bg-slate-800 px-4 py-2 rounded-lg text-amber-300 font-semibold border border-slate-700">
                            Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª: <span id="admin-total-count">0</span>
                        </div>
                        <button onclick="logoutAdmin()" class="flex items-center gap-2 text-slate-400 hover:text-red-400 transition" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                            <i class="fas fa-sign-out-alt text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-auto p-6 relative">
                    <div id="admin-loading" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-800/80 z-10 hidden">
                        <i class="fas fa-spinner fa-spin text-4xl text-amber-500 mb-4"></i>
                        <p class="text-white">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                    </div>
                    
                    <div id="admin-empty" class="h-full flex flex-col items-center justify-center text-slate-500 hidden">
                        <i class="fas fa-clock text-6xl mb-4 opacity-50"></i>
                        <p class="text-xl">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                    </div>

                    <div class="overflow-x-auto rounded-xl border border-slate-700" id="admin-table-container">
                        <table class="w-full text-right border-collapse">
                            <thead>
                                <tr class="bg-slate-900 text-slate-300 text-sm">
                                    <th class="p-4 font-semibold">Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</th>
                                    <th class="p-4 font-semibold">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                    <th class="p-4 font-semibold text-center">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th>
                                    <th class="p-4 font-semibold text-center">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                    <th class="p-4 font-semibold">ÙˆÙ‚Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</th>
                                    <th class="p-4 font-semibold text-center">Ø¥Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body">
                                <!-- Data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Application Logic (Firebase + Vanilla JS) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration & Initialization ---
        const CURRENT_ACTIVE_WEEK = 1; // <--- Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„ÙØªØ­ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
        const ADMIN_PIN = '2026';

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyCAsmcMVSGXXGALh5xZmKNDwmv7fQMrmGo",
            authDomain: "pctct-b700f.firebaseapp.com",
            projectId: "pctct-b700f",
            storageBucket: "pctct-b700f.firebasestorage.app",
            messagingSenderId: "551206501024",
            appId: "1:551206501024:web:fa2ac8a45f2aada58267c5",
            measurementId: "G-YYHKWYK8YN"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'pctct-b700f';

        // --- State Variables ---
        let currentUser = null;
        let participant = { name: '', phone: '' };
        let selectedWeek = 1;
        let answers = {};
        let unsubscribeSubmissions = null;
        let isSubmitting = false;

        // --- Quiz Data ---
        const quizData = {
            1: [
                { id: 'q1_1', videoId: '0MofM3htwyE', text: 'Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø±Ø¦ÙŠØŒ Ù‡Ù„ ÙŠÙØ¹Ø¯ Ù‚ÙŠØ§Ù… Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ Ø¨Ø­Ø¸Ø± Ø¢Ø¨Ø§Ø¦Ù‡Ù… ÙÙŠ Ø´Ø¨ÙƒØ§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ ÙˆÙ…Ù†Ø¹Ù‡Ù… Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø± Ù…Ù† Ø§Ù„Ø¹Ù‚ÙˆÙ‚ØŸ', options: ['Ù†Ø¹Ù…ØŒ ÙŠÙØ¹Ø¯ Ù…Ù† Ø§Ù„Ø¹Ù‚ÙˆÙ‚', 'Ù„Ø§ØŒ ÙŠÙØ¹Ø¯ Ù…Ù† Ø§Ù„Ø­Ø±ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ©', 'Ù…ÙƒØ±ÙˆÙ‡ ÙˆÙ„ÙƒÙ† Ù„ÙŠØ³ Ø¹Ù‚ÙˆÙ‚Ø§Ù‹'], answer: 'Ù†Ø¹Ù…ØŒ ÙŠÙØ¹Ø¯ Ù…Ù† Ø§Ù„Ø¹Ù‚ÙˆÙ‚' },
                { id: 'q1_2', text: 'Ù…Ø§ Ù‡Ùˆ Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ø°ÙŠ Ø°ÙƒØ±Ù‡ Ø§Ù„Ø´ÙŠØ® Ù„Ø³Ø¨Ø¨ Ù„Ø¬ÙˆØ¡ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ Ù„Ø­Ø¸Ø± Ø¢Ø¨Ø§Ø¦Ù‡Ù… ÙˆØ£Ù…Ù‡Ø§ØªÙ‡Ù…ØŸ', options: ['Ù„Ø­Ù…Ø§ÙŠØ© Ø®ØµÙˆØµÙŠØªÙ‡Ù… Ù…Ù† Ø£ØµØ¯Ù‚Ø§Ø¦Ù‡Ù…', 'Ù„Ø£Ù†Ù‡Ù… ÙŠØ£ØªÙˆÙ† Ø¨Ø£ÙØ¹Ø§Ù„ ØªØ³Ø®Ø· ÙˆØ§Ù„Ø¯ÙŠÙ‡Ù… ÙˆÙŠØ³ØªØ­ÙŠÙˆÙ† Ù…Ù† Ø§Ø·Ù„Ø§Ø¹Ù‡Ù… Ø¹Ù„ÙŠÙ‡Ø§', 'Ø¨Ø³Ø¨Ø¨ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬ÙŠØ§Ù„'], answer: 'Ù„Ø£Ù†Ù‡Ù… ÙŠØ£ØªÙˆÙ† Ø¨Ø£ÙØ¹Ø§Ù„ ØªØ³Ø®Ø· ÙˆØ§Ù„Ø¯ÙŠÙ‡Ù… ÙˆÙŠØ³ØªØ­ÙŠÙˆÙ† Ù…Ù† Ø§Ø·Ù„Ø§Ø¹Ù‡Ù… Ø¹Ù„ÙŠÙ‡Ø§' },
                { id: 'q1_3', text: 'ÙƒÙŠÙ ÙˆØµÙ Ø§Ù„Ø´ÙŠØ® Ù‚ØµØ© Ø§Ù„Ø¬Ø¯Ø© Ø§Ù„ØªÙŠ Ø·Ù„Ø¨Øª ÙØªØ­ Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù‡Ø§ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø­ÙØ§Ø¯Ù‡Ø§ Ù„Ø£Ù†Ù‡Ù… Ù„Ø§ ÙŠØªÙˆØ§ØµÙ„ÙˆÙ† Ù…Ø¹Ù‡Ø§ØŸ', options: ['ÙˆØµÙÙ‡ Ø¨Ø£Ù†Ù‡ Ø¬ÙØ§Ø¡ ÙˆÙ‚Ø·ÙŠØ¹Ø©', 'ÙˆØµÙÙ‡ Ø¨Ø£Ù†Ù‡ ØªØ·ÙˆØ± Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ù„Ø¹Ù„Ø§Ù‚Ø§Øª', 'ÙˆØµÙÙ‡ Ø¨Ø£Ù†Ù‡ Ø­Ø±Øµ Ù…Ø­Ù…ÙˆØ¯ Ù…Ù† Ø§Ù„Ø¬Ø¯Ø©'], answer: 'ÙˆØµÙÙ‡ Ø¨Ø£Ù†Ù‡ Ø¬ÙØ§Ø¡ ÙˆÙ‚Ø·ÙŠØ¹Ø©' }
            ],
            2: [
                { id: 'q2_1', text: 'Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù†Ø¨ÙŠ Ø§Ù„Ø°ÙŠ Ù„ÙÙ‚Ø¨ Ø¨Ø£Ø¨ÙŠ Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡ØŸ', options: ['Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…', 'Ù…ÙˆØ³Ù‰ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…', 'Ù…Ø­Ù…Ø¯ ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ³Ù„Ù…'], answer: 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…' },
                { id: 'q2_2', text: 'ÙƒÙ… Ø¹Ø¯Ø¯ Ø³ÙˆØ± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ', options: ['114 Ø³ÙˆØ±Ø©', '110 Ø³ÙˆØ±Ø©', '120 Ø³ÙˆØ±Ø©'], answer: '114 Ø³ÙˆØ±Ø©' },
                { id: 'q2_3', text: 'Ù…Ø§ Ù‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ØªÙŠ ØªÙØµÙ„Ù‰ ÙÙŠ Ù„ÙŠØ§Ù„ÙŠ Ø±Ù…Ø¶Ø§Ù† ÙÙ‚Ø·ØŸ', options: ['ØµÙ„Ø§Ø© Ø§Ù„Ø¶Ø­Ù‰', 'ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­', 'ØµÙ„Ø§Ø© Ø§Ù„ÙˆØªØ±'], answer: 'ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­' }
            ],
            3: [
                { id: 'q3_1', text: 'ÙÙŠ Ø£ÙŠ Ø¹Ø§Ù… Ù‡Ø¬Ø±ÙŠ ÙÙØ±Ø¶ ØµÙŠØ§Ù… Ø±Ù…Ø¶Ø§Ù†ØŸ', options: ['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø«Ø§Ù„Ø«'], answer: 'Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ' },
                { id: 'q3_2', text: 'Ù…Ù† Ù‡Ùˆ Ø§Ù„ØµØ­Ø§Ø¨ÙŠ Ø§Ù„Ø°ÙŠ Ø£Ø´Ø§Ø± Ø¨Ø­ÙØ± Ø§Ù„Ø®Ù†Ø¯Ù‚ØŸ', options: ['Ø¹Ù…Ø± Ø¨Ù† Ø§Ù„Ø®Ø·Ø§Ø¨', 'Ø³Ù„Ù…Ø§Ù† Ø§Ù„ÙØ§Ø±Ø³ÙŠ', 'Ø¹Ù„ÙŠ Ø¨Ù† Ø£Ø¨ÙŠ Ø·Ø§Ù„Ø¨'], answer: 'Ø³Ù„Ù…Ø§Ù† Ø§Ù„ÙØ§Ø±Ø³ÙŠ' }
            ],
            4: [
                { id: 'q4_1', text: 'Ù…ØªÙ‰ ÙŠØ¨Ø¯Ø£ ÙˆÙ‚Øª Ø¥Ø®Ø±Ø§Ø¬ Ø²ÙƒØ§Ø© Ø§Ù„ÙØ·Ø±ØŸ', options: ['Ù…Ù† Ø£ÙˆÙ„ Ø±Ù…Ø¶Ø§Ù†', 'ÙÙŠ Ø§Ù„Ø¹Ø´Ø± Ø§Ù„Ø£ÙˆØ§Ø®Ø±', 'Ù‚Ø¨Ù„ ØµÙ„Ø§Ø© Ø§Ù„Ø¹ÙŠØ¯'], answer: 'Ù…Ù† Ø£ÙˆÙ„ Ø±Ù…Ø¶Ø§Ù†' },
                { id: 'q4_2', text: 'Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù„ÙŠÙ„Ø© Ø§Ù„ØªÙŠ Ù‡ÙŠ Ø®ÙŠØ± Ù…Ù† Ø£Ù„Ù Ø´Ù‡Ø±ØŸ', options: ['Ù„ÙŠÙ„Ø© Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡', 'Ù„ÙŠÙ„Ø© Ø§Ù„Ù‚Ø¯Ø±', 'Ù„ÙŠÙ„Ø© Ø§Ù„Ù†ØµÙ Ù…Ù† Ø´Ø¹Ø¨Ø§Ù†'], answer: 'Ù„ÙŠÙ„Ø© Ø§Ù„Ù‚Ø¯Ø±' }
            ]
        };

        // --- Authentication ---
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (error) { 
                console.error("Auth Error:", error); 
            }
        }
        initAuth();
        onAuthStateChanged(auth, (user) => { currentUser = user; });

        // --- Global Functions ---
        window.switchView = (viewId) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            
            if (viewId !== 'admin-dashboard' && unsubscribeSubmissions) {
                unsubscribeSubmissions();
                unsubscribeSubmissions = null;
            }

            if (viewId === 'week-selection') renderWeeks();
            if (viewId === 'admin-dashboard') startAdminListener();
        };

        window.resetAndGoHome = () => {
            participant = { name: '', phone: '' };
            document.getElementById('input-name').value = '';
            document.getElementById('input-phone').value = '';
            window.switchView('home');
        };

        window.logoutAdmin = () => {
            document.getElementById('input-admin-pin').value = '';
            window.switchView('home');
        };

        window.handleSelectWeek = (week) => {
            selectedWeek = week;
            answers = {};
            renderQuiz();
            window.switchView('quiz');
        };

        window.selectOption = (questionId, optionValue) => {
            answers[questionId] = optionValue;
            
            const radios = document.getElementsByName(questionId);
            radios.forEach(radio => {
                const label = radio.closest('label');
                if (radio.value === optionValue) {
                    label.className = "flex items-center p-4 rounded-xl cursor-pointer transition border bg-amber-500/10 border-amber-500 text-amber-300";
                } else {
                    label.className = "flex items-center p-4 rounded-xl cursor-pointer transition border bg-slate-800 border-slate-700 text-slate-300 hover:bg-slate-700";
                }
            });

            const questions = quizData[selectedWeek];
            const allAnswered = questions.every(q => answers[q.id]);
            const submitBtn = document.getElementById('btn-submit-quiz');
            const submitIcon = document.getElementById('submit-icon');
            
            if (allAnswered) {
                submitBtn.disabled = false;
                submitBtn.className = "flex-1 py-3 rounded-xl font-bold text-slate-900 flex items-center justify-center gap-2 transition bg-amber-500 hover:bg-amber-400";
                submitIcon.classList.remove('hidden');
            } else {
                submitBtn.disabled = true;
                submitBtn.className = "flex-1 py-3 rounded-xl font-bold text-slate-900 flex items-center justify-center gap-2 transition bg-slate-600 cursor-not-allowed opacity-50";
                submitIcon.classList.add('hidden');
            }
        };

        window.submitQuiz = async () => {
            if (isSubmitting) return;
            if (!currentUser) {
                alert("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù….. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.");
                return;
            }

            isSubmitting = true;
            const btn = document.getElementById('btn-submit-quiz');
            document.getElementById('submit-text').innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            const weekQuestions = quizData[selectedWeek];
            let score = 0;
            weekQuestions.forEach(q => { if (answers[q.id] === q.answer) score++; });

            try {
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const submissionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'ramadan_submissions');
                await addDoc(submissionsRef, {
                    userId: currentUser.uid,
                    name: participant.name,
                    phone: participant.phone,
                    week: selectedWeek,
                    score: score,
                    totalQuestions: weekQuestions.length,
                    answers: answers,
                    timestamp: serverTimestamp()
                });
                window.switchView('success');
            } catch (error) {
                console.error("Submission error:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙÙŠ Firebase ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            } finally {
                isSubmitting = false;
                document.getElementById('submit-text').innerText = 'Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª';
            }
        };

        window.sendWhatsApp = (phone, name, week, score, total) => {
            let formattedPhone = phone.replace(/\D/g, '');
            if (formattedPhone.startsWith('0')) formattedPhone = formattedPhone.substring(1);
            if (!formattedPhone.startsWith('968') && formattedPhone.length === 8) {
                formattedPhone = '968' + formattedPhone; 
            }
            const message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}! ğŸŒ™\nÙ†Ø¨Ø§Ø±Ùƒ Ù„Ùƒ Ù…Ø´Ø§Ø±ÙƒØªÙƒ ÙˆØ¥Ø¨Ø¯Ø§Ø¹Ùƒ ÙÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${week}). ğŸ‰\nÙ†ØªÙŠØ¬ØªÙƒ Ù‡ÙŠ: ${score} Ù…Ù† ${total}.\nØªÙ‚Ø¨Ù„ Ø§Ù„Ù„Ù‡ Ø·Ø§Ø¹ØªÙƒÙ… ÙˆÙƒÙ„ Ø¹Ø§Ù… ÙˆØ£Ù†ØªÙ… Ø¨Ø®ÙŠØ±. âœ¨`;
            window.open(`https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`, '_blank');
        };

        // --- Event Listeners ---
        document.getElementById('form-register').addEventListener('submit', (e) => {
            e.preventDefault();
            participant.name = document.getElementById('input-name').value.trim();
            participant.phone = document.getElementById('input-phone').value.trim();
            if (participant.name && participant.phone) {
                document.getElementById('display-name').innerText = participant.name;
                window.switchView('week-selection');
            }
        });

        document.getElementById('form-admin-login').addEventListener('submit', (e) => {
            e.preventDefault();
            const pin = document.getElementById('input-admin-pin').value;
            const errorEl = document.getElementById('admin-error');
            if (pin === ADMIN_PIN) {
                errorEl.classList.add('hidden');
                window.switchView('admin-dashboard');
            } else {
                errorEl.classList.remove('hidden');
            }
        });

        // --- Rendering Logic ---
        function renderWeeks() {
            const container = document.getElementById('weeks-container');
            container.innerHTML = '';
            [1, 2, 3, 4].forEach(week => {
                const isLocked = week > CURRENT_ACTIVE_WEEK;
                const btnHTML = `
                    <button 
                        ${isLocked ? 'disabled' : `onclick="handleSelectWeek(${week})"`}
                        class="p-6 rounded-2xl flex flex-col items-center justify-center gap-3 transition group border ${isLocked ? 'bg-slate-800/50 border-slate-700/50 cursor-not-allowed opacity-60' : 'bg-slate-900 hover:bg-slate-700 border-slate-700 hover:border-amber-500 text-white'}"
                    >
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${isLocked ? 'bg-slate-800 text-slate-500' : 'bg-slate-800 group-hover:bg-amber-500/20 text-amber-400 group-hover:text-amber-300'}">
                            ${isLocked ? '<i class="fas fa-lock text-lg"></i>' : `<span class="text-xl font-bold">${week}</span>`}
                        </div>
                        <span class="font-semibold ${isLocked ? 'text-slate-500' : ''}">
                            ${isLocked ? 'ÙŠÙØªØ­ Ù‚Ø±ÙŠØ¨Ø§Ù‹' : `Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${week}`}
                        </span>
                    </button>
                `;
                container.innerHTML += btnHTML;
            });
        }

        function renderQuiz() {
            const questions = quizData[selectedWeek];
            document.getElementById('quiz-title').innerText = `Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${selectedWeek}`;
            document.getElementById('quiz-count').innerText = `${questions.length} Ø£Ø³Ø¦Ù„Ø©`;
            
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                let videoHTML = '';
                if (q.videoId) {
                    videoHTML = `
                        <div class="mb-6 rounded-xl overflow-hidden shadow-lg border border-slate-700 bg-black">
                            <iframe width="100%" src="https://www.youtube.com/embed/${q.videoId}?rel=0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full aspect-video"></iframe>
                        </div>
                    `;
                }

                let optionsHTML = q.options.map(opt => {
                    const isSelected = answers[q.id] === opt;
                    return `
                        <label class="flex items-center p-4 rounded-xl cursor-pointer transition border ${isSelected ? 'bg-amber-500/10 border-amber-500 text-amber-300' : 'bg-slate-800 border-slate-700 text-slate-300 hover:bg-slate-700'}">
                            <input type="radio" name="${q.id}" value="${opt}" ${isSelected ? 'checked' : ''} onchange="selectOption('${q.id}', '${opt}')" class="w-5 h-5 text-amber-500 bg-slate-900 border-slate-600 focus:ring-amber-500 focus:ring-offset-slate-900">
                            <span class="mr-3 font-medium">${opt}</span>
                        </label>
                    `;
                }).join('');

                container.innerHTML += `
                    <div class="bg-slate-900/50 p-5 rounded-2xl border border-slate-700/50">
                        ${videoHTML}
                        <h3 class="text-lg text-white font-semibold mb-4 leading-relaxed">
                            <span class="text-amber-500 ml-2">${index + 1}.</span> ${q.text}
                        </h3>
                        <div class="space-y-3">
                            ${optionsHTML}
                        </div>
                    </div>
                `;
            });

            const allAnswered = questions.every(q => answers[q.id]);
            const submitBtn = document.getElementById('btn-submit-quiz');
            const submitIcon = document.getElementById('submit-icon');
            
            if (allAnswered) {
                submitBtn.disabled = false;
                submitBtn.className = "flex-1 py-3 rounded-xl font-bold text-slate-900 flex items-center justify-center gap-2 transition bg-amber-500 hover:bg-amber-400";
                submitIcon.classList.remove('hidden');
            } else {
                submitBtn.disabled = true;
                submitBtn.className = "flex-1 py-3 rounded-xl font-bold text-slate-900 flex items-center justify-center gap-2 transition bg-slate-600 cursor-not-allowed opacity-50";
                submitIcon.classList.add('hidden');
            }
        }

        function startAdminListener() {
            if (!currentUser) return;
            document.getElementById('admin-loading').classList.remove('hidden');
            
            const submissionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'ramadan_submissions');
            
            unsubscribeSubmissions = onSnapshot(submissionsRef, (snapshot) => {
                document.getElementById('admin-loading').classList.add('hidden');
                
                let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                data.sort((a, b) => {
                    const timeA = a.timestamp?.toMillis?.() || 0;
                    const timeB = b.timestamp?.toMillis?.() || 0;
                    return timeB - timeA; 
                });

                document.getElementById('admin-total-count').innerText = data.length;
                
                const tableBody = document.getElementById('admin-table-body');
                const emptyState = document.getElementById('admin-empty');
                const tableContainer = document.getElementById('admin-table-container');

                if (data.length === 0) {
                    emptyState.classList.remove('hidden');
                    tableContainer.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                    tableBody.innerHTML = '';
                    
                    data.forEach((sub, idx) => {
                        const dateStr = sub.timestamp ? new Intl.DateTimeFormat('ar-EG', { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true }).format(sub.timestamp.toDate()) : 'Ø§Ù„Ø¢Ù†';
                        const isFullMark = sub.score === sub.totalQuestions;
                        
                        tableBody.innerHTML += `
                            <tr class="border-b border-slate-700/50 hover:bg-slate-700/30 transition ${idx % 2 === 0 ? 'bg-slate-800/30' : ''}">
                                <td class="p-4 font-medium text-white">${sub.name}</td>
                                <td class="p-4 text-amber-200/80" dir="ltr">${sub.phone}</td>
                                <td class="p-4 text-center"><span class="bg-slate-700 text-white px-3 py-1 rounded-full text-xs">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${sub.week}</span></td>
                                <td class="p-4 text-center"><span class="px-3 py-1 rounded-full text-xs font-bold ${isFullMark ? 'bg-green-500/20 text-green-400' : 'bg-slate-700 text-slate-300'}">${sub.score} / ${sub.totalQuestions}</span></td>
                                <td class="p-4 text-sm text-slate-400 whitespace-nowrap">${dateStr}</td>
                                <td class="p-4 text-center">
                                    <button onclick="sendWhatsApp('${sub.phone}', '${sub.name}', ${sub.week}, ${sub.score}, ${sub.totalQuestions})" class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-semibold transition shadow-lg shadow-green-900/20" title="Ù…Ø±Ø§Ø³Ù„Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
                                        <i class="fab fa-whatsapp text-lg"></i>
                                        <span>Ù…Ø±Ø§Ø³Ù„Ø©</span>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
            }, (error) => {
                console.error("Error fetching submissions:", error);
                document.getElementById('admin-loading').classList.add('hidden');
            });
        }
    </script>
</body>
</html>